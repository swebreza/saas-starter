# Studio 24 · Environment & Deployment Reference

Studio 24 operates across `local`, `staging`, and `production` environments. This guide documents required tooling, environment variables, and deployment steps. Secrets live in the appropriate platform secret managers (Vercel, Supabase, n8n host, Stripe, etc.) and must never be committed.

---

## 1. Tooling & Services

| Service | Purpose | Environment(s) | Notes |
| --- | --- | --- | --- |
| Vercel | Host Next.js app & marketing site | staging, production | Preview deployments enabled for PRs |
| Supabase | Auth, Postgres, storage, scheduled functions | local (optional), staging, production | Separate project per environment |
| n8n | Workflow automation | local docker, staging (Fly/Railway), production | Deployed via Docker image with persistent volume |
| Stripe | Billing & invoicing | staging (test mode), production (live) | Use separate webhook secrets |
| Redis (Upstash) | Optional cache for feature flags & rate limiting | staging, production | Can be deferred until needed |
| Sentry/Logflare | Monitoring & logging | staging, production | Choose preferred vendor during Phase 5 |

Local development can run Supabase via Docker or connect to staging Supabase (with caution). n8n can run locally using Docker Compose for workflow development.

---

## 2. Environment Variables

> ✅ Required now  ⭕️ Optional/deferred until feature launch

### 2.1 Next.js / Vercel
| Variable | Scope | Status | Description |
| --- | --- | --- | --- |
| `NEXT_PUBLIC_APP_URL` | client | ✅ | Base URL for links + metadata (`http://localhost:3000` locally) |
| `NEXT_PUBLIC_SUPABASE_URL` | client | ✅ | Supabase project URL |
| `SUPABASE_ANON_KEY` | server+client | ✅ | Supabase anon key (safe for client) |
| `SUPABASE_SERVICE_ROLE_KEY` | server | ✅ | Service role for Supabase (protect carefully) |
| `DATABASE_URL` | server | ✅ | Supabase Postgres connection string for Drizzle |
| `AUTH_SECRET` | server | ✅ | Auth.js secret (`openssl rand -base64 32`) |
| `GEMINI_API_KEY` | server | ✅ | Google Gemini key (free tier acceptable initially) |
| `GEMINI_MODEL` | server | ⭕️ | Override model (`gemini-2.5-flash` default) |
| `MOCK_GEMINI` | server | ⭕️ | `true` to short-circuit AI calls locally |
| `NEXT_PUBLIC_CANVA_APP_ID` | client | ✅ | Canva App ID |
| `CANVA_CLIENT_SECRET` | server | ✅ | Canva OAuth client secret |
| `CANVA_REDIRECT_URI` | server | ✅ | `${BASE_URL}/api/integrations/canva/callback` |
| `CANVA_SCOPES` | server | ⭕️ | Space-separated scopes; defaults to recommended set |
| `CANVA_API_BASE_URL` | server | ⭕️ | If Canva exposes region-specific endpoints |
| `REMOTION_SITE_ID` | server | ✅ | Site ID generated by `remotion lambda sites create` |
| `REMOTION_SERVE_URL` | server | ⭕️ | Alternative to site ID if hosting bundle manually |
| `REMOTION_AWS_REGION` | server | ✅ | AWS region for Remotion Lambda renders |
| `REMOTION_AWS_ACCESS_KEY_ID` | server | ✅ | Programmatic AWS access key for Remotion Lambda |
| `REMOTION_AWS_SECRET_ACCESS_KEY` | server | ✅ | Programmatic AWS secret key |
| `REMOTION_MAX_CONCURRENCY` | server | ⭕️ | Optional cap on concurrent renders |
| `REMOTION_OUTPUT_BUCKET` | server | ⭕️ | Custom S3 bucket for rendered assets (if overriding default) |
| `N8N_BASE_URL` | server | ✅ | URL to n8n instance (with trailing slash) |
| `N8N_ACCESS_TOKEN` | server | ✅ | Personal access token/service token for n8n REST API |
| `N8N_WEBHOOK_SECRET` | server | ✅ | Shared secret to verify inbound n8n webhooks |
| `STRIPE_SECRET_KEY` | server | ✅ | Stripe secret (test or live) |
| `STRIPE_WEBHOOK_SECRET` | server | ✅ | Stripe webhook signing secret |
| `STRIPE_PRICE_ID_PRO` | server | ✅ | Price ID for Pro plan |
| `STRIPE_PRICE_ID_AGENCY` | server | ✅ | Price ID for Agency plan |
| `STRIPE_USAGE_PRODUCT_ID` | server | ⭕️ | Product for metered post credits |
| `BASE_URL` | server | ✅ | Fully qualified URL for callbacks (e.g., `https://staging.studio24.app`) |
| `NEXT_PUBLIC_SENTRY_DSN` | client | ⭕️ | When error monitoring is enabled |
| `SENTRY_AUTH_TOKEN` | server | ⭕️ | Deploy-time token for uploading source maps |
| `UPSTASH_REDIS_REST_URL` / `UPSTASH_REDIS_REST_TOKEN` | server | ⭕️ | Required once Redis caching is used |
| `FEATURE_FLAGS` | server | ⭕️ | JSON string for toggling beta features (or use Supabase table) |

### 2.2 n8n Instance
Set via environment variables / `.env` on n8n host:
- `N8N_PORT` (default `5678`)
- `N8N_ENCRYPTION_KEY` (generate once, keep secret)
- `N8N_BASIC_AUTH_ACTIVE=true` (for UI) + `N8N_BASIC_AUTH_USER/PASSWORD`
- `N8N_DIAGNOSTICS_ENABLED=false`
- `N8N_PAYLOAD_SIZE_MAX=32` (MB, adjust if required)
- `SUPABASE_SERVICE_ROLE_KEY` (for direct Supabase node access if needed)
- `REMOTION_SITE_ID`, `REMOTION_AWS_REGION`, `REMOTION_AWS_ACCESS_KEY_ID`, `REMOTION_AWS_SECRET_ACCESS_KEY`
- `CANVA_CLIENT_ID`, `CANVA_CLIENT_SECRET`
- Integrations credentials managed inside n8n credential store.

### 2.3 Supabase Config
Via Supabase dashboard/CLI:
- API keys (anon, service-role) already captured above.
- Enable extensions: `pgcrypto`, `uuid-ossp`.
- Configure Storage buckets: `media`, `exports`, `tmp`.
- Edge functions environment (once used) hold minimal secrets (e.g., analytics).

---

## 3. Local Development Setup

1. **Install dependencies**
   ```bash
   pnpm install
   ```
2. **Create `.env.local`**
   ```bash
   cp .env.example .env.local
   ```
   Populate with keys (use Supabase & Stripe test creds, Gemini free key, optional mock flags).
3. **Optional local Supabase**
   - Install Supabase CLI (`brew install supabase/tap/supabase`).
   - Run `supabase start` to spin up Postgres/auth/storage locally.
   - Update `.env.local` `DATABASE_URL` & Supabase keys accordingly.
4. **Optional local n8n**
   ```bash
   docker compose -f docker-compose.n8n.yml up
   ```
   or install globally (`npx n8n`) and run with `.env.n8n.local`.
5. **Run dev server**
   ```bash
   pnpm dev
   ```
6. **Run worker scripts (when applicable)**
   - Automation worker replaced by n8n; no separate Node worker required.
   - For legacy local video rendering tests, run `pnpm auto-reel:worker` (optional).

---

## 4. Deployment Checklist

### 4.1 Supabase
- Create project per environment.
- Run migrations via `pnpm db:migrate` (Drizzle) or Supabase CLI.
- Apply RLS policies (`supabase db push`).
- Seed baseline data (plan features, workflow templates, brand defaults) using `scripts/seed-workspace.ts`.

### 4.2 n8n
- Deploy container (Fly.io, Railway, Render). Mount persistent volume.
- Set environment variables and SSL configuration.
- Import workflows from `workflows/n8n/*.json` (staging first, then production).
- Configure credentials (Supabase, Stripe, Gemini, Canva, Remotion Worker, social OAuth apps).
- Lock down UI with basic auth; restrict IP if possible.

### 4.3 Stripe
- Create products/prices for plans and metered add-ons.
- Configure webhook endpoint: `https://<env>.studio24.app/api/webhooks/stripe`.
- Set up customer portal configuration (if offering self-service).

### 4.4 Social Integrations
- Register OAuth apps for each platform (YouTube, Meta, TikTok, LinkedIn, X).
- Configure redirect URIs: `https://<env>.studio24.app/api/integrations/<provider>/callback`.
- Store client IDs/secrets in environment variables or Supabase secret store.

### 4.5 Monitoring
- Set up Sentry/Logflare accounts; configure DSNs/integrations.
- Configure uptime monitoring for Next.js and n8n endpoints.
- Define alert channels (Slack/Email) for automation failures and billing issues.

---

## 5. Secret Management Practices

- **Local**: `.env.local` (gitignored). Consider `direnv` or 1Password CLI for secure sharing.
- **Vercel**: Use per-environment secrets; avoid reusing production secrets in preview.
- **Supabase**: Store service role key and encryption helper secrets in Supabase configuration, never expose to client.
- **n8n**: Use credential store with encryption key and limit staff access.
- **Rotation**: Document rotation cadence (Gemini monthly, Stripe yearly, social tokens per platform); automate where possible.

---

## 6. Integration Checklists

### 6.1 Canva
- Register app on https://www.canva.dev/.
- Configure redirect URIs (`/api/integrations/canva/callback`).
- Request required scopes (defaults: `openid profile design:read design:write`).
- Store App ID + secret in environment variables.
- For embedded editor, optionally host Canva SDK or use CDN (`NEXT_PUBLIC_CANVA_CREATE_SDK_URL`).

### 6.2 Remotion Worker
- Deploy Remotion site (`npx remotion lambda sites create`) and record `REMOTION_SITE_ID`.
- Configure AWS credentials and region variables; document limits in `docs/remotion.md`.
- Optionally set `REMOTION_MAX_CONCURRENCY` and `REMOTION_OUTPUT_BUCKET` for cost control.

### 6.3 Social Platforms
- Ensure each OAuth app has appropriate scopes (publish + analytics).
- Implement token refresh endpoints in Next.js; n8n must never store refresh tokens permanently.
- Track rate-limit headers; throttle n8n workflows as needed.

---

## 7. Troubleshooting

- **CORS/Redirect Issues**: Confirm `BASE_URL` matches deployed domain. Update Canva/social app settings if URLs change.
- **Supabase Auth Errors**: Check RLS policies and ensure service role key is available for backend calls only.
- **n8n Webhook Failures**: Verify `N8N_WEBHOOK_SECRET` matches between Next.js and n8n webhook nodes; inspect n8n execution log.
- **Stripe Webhook Timeouts**: Stripe requires 10s response; handle events asynchronously if needed.
- **High AI Costs**: Use `MOCK_GEMINI=true` locally; monitor `automation_runs.cost_estimate` for spikes.

Keep this document current as integrations or infrastructure change. It is the single source of truth for environment configuration.